---
#
# Play to install SpringBoot pre-requisite packages
#
#

- name: Update all packages
  yum:
    name: '*'
    state: latest
  become: true
  become_method: sudo
  tags:
    - springboot_prereqs

- name: Install Development Tools
  yum:
    name: "@Development tools"
    state: present
  become: true
  become_method: sudo
  tags:
    - springboot_prereqs

- name: Install Python PIP
  yum:
    name: python-pip
    state: present
  become: true
  become_method: sudo
  tags:
    - springboot_prereqs

- name: Install Boto
  pip:
    name: "{{item}}"
    state: present
  become: true
  become_method: sudo
  with_items:
    - boto
    - botocore
    - boto3
  tags:
    - springboot_prereqs

- name: Install git
  yum:
    name: git
    state: present
  become: true
  become_method: sudo
  tags:
    - springboot_prereqs

- name: Make {{downloads}} directory
  file:
    path: "{{downloads}}"
    state: directory
    recurse: yes
  become: true
  become_method: sudo
  tags:
    - springboot_prereqs

# Better to download from AWS S3, need to upload to S3 bucket
#- name: Download Oracle JDK (Oracle Site)
#  shell: |
#    wget --no-cookies --no-check-certificate --header "Cookie: gpw_e24=http%3A%2F%2Fwww.oracle.com%2F; oraclelicense=accept-securebackup-cookie" "http://download.oracle.com/otn-pub/java/jdk/8u172-b11/a58eab1ec242421181065cdc37240b08/jdk-8u172-linux-x64.rpm?AuthParam=1531631611_7446f47cad90f7cad585f8b27968320e"
#  args:
#    executable: /bin/bash
#  become: true
#  become_method: sudo
#  tags:
#    - springboot_prereqs

- name: Download Oracle JDK 1.8 (AWS S3)
  aws_s3:
    aws_access_key: "{{aws_access_key}}"
    aws_secret_key: "{{aws_secret_key}}"
    bucket: rdurvasula-3rdparty
    object: "/java/jdk-8u172-linux-x64.rpm"
    dest: "{{downloads}}/jdk-8u172-linux-x64.rpm"
    mode: get
    region: "{{region}}"
    metadata: "Content-Type=application/octet-stream"
  become: true
  become_method: sudo
  tags:
    - springboot_prereqs

- name: Install JDK 1.8 rpm
  yum:
    name: "{{downloads}}/jdk-8u172-linux-x64.rpm"
    state: present
  become: true
  become_method: sudo
  tags:
    - springboot_prereqs

- name: Set default java, javac
  shell: |
    alternatives --set java "{{java_home}}/jre/bin/java" ;
    alternatives --set javac "{{java_home}}/bin/javac"
  args:
    executable: /bin/bash
  become: true
  become_method: sudo
  tags:
    - springboot_prereqs

- name: Install maven
  get_url:
    url: "{{maven_url}}/{{maven_uri}}"
    dest: "/root/{{zip_file}}"
  become: true
  become_method: sudo
  tags:
    - springboot_prereqs

- name: Extract maven tar
  unarchive:
    src: "/root/{{zip_file}}"
    dest: "/opt/"
    remote_src: yes
  become: true
  become_method: sudo
  tags:
    - springboot_prereqs

- name: Create link for maven
  file:
    src: "/opt/{{maven_dir}}"
    dest: "/opt/{{maven_link}}"
    state: link
  become: true
  become_method: sudo
  tags:
    - springboot_prereqs

- name: Create m2_profile file
  file:
    path: "/etc/profile.dm2_profile"
    state: file
    mode: "u+rwx"
  become: true
  become_method: sudo
  tags:
    - springboot_prereqs

- name: Set environment variables for maven
  lineinfile:
    path: "/etc/profile.d/m2_profile"
    line: "{{item}}"
    insertafter: EOF
  become: true
  become_method: sudo
  with_items:
    - "export M2_HOME=/opt/{{maven_link}}"
    - "export PATH=${PATH}:${M2_HOME}/bin"
  tags:
    - springboot_prereqs

- name: Update profiles
  lineinfile:
    path: "{{item}}"
    line: "source /etc/profile.d/m2_profile"
    insertafter: EOF
  become: true
  become_method: sudo
  with_items:
    - "/etc/profile"
    - "/root/.bashrc"
  tags:
    - springboot_prereqs

