---
#
# Play to install application packages
#
#
#

- name: Download PostgreSQL rpms from S3
  aws_s3:
    aws_access_key: "{{aws_access_key}}"
    aws_secret_key: "{{aws_secret_key}}"
    bucket: rdurvasula-3rdparty
    object: "/postgresql/{{item}}"
    dest: "/root/{{item}}"
    mode: get
    region: "{{region}}"
    metadata: "Content-Type=application/octet-stream"
  become: true
  become_method: sudo
  with_items:
    - postgresql96-contrib-9.6.10-1PGDG.rhel7.x86_64.rpm
    - postgresql96-libs-9.6.10-1PGDG.rhel7.x86_64.rpm
    - postgresql96-9.6.10-1PGDG.rhel7.x86_64.rpm
    - postgresql96-server-9.6.10-1PGDG.rhel7.x86_64.rpm
  tags:
    - install_postgres

- name: Install PostgreSQL server packages
  yum:
    name: "/root/{{item}}"
    state: present
  become: true
  become_method: sudo
  with_items:
    - postgresql96-libs-9.6.10-1PGDG.rhel7.x86_64.rpm
    - postgresql96-9.6.10-1PGDG.rhel7.x86_64.rpm
    - postgresql96-server-9.6.10-1PGDG.rhel7.x86_64.rpm
    - postgresql96-contrib-9.6.10-1PGDG.rhel7.x86_64.rpm
  tags:
    - install_postgres

- name: Initialize PostgreSQL Database
  shell: |
    cd "{{postgres_bin_home}}" ;
    ./initdb
  args:
    executable: /bin/bash
  become: true
  become_user: "{{postgres_user}}"
  tags:
    - install_postgres

- name: Backup pg_hba.conf
  copy:
    src: "{{postgres_home}}/9.6/data/pg_hba.conf"
    dest: "{{postgres_home}}/9.6/data/pg_hba.conf.orig"
    remote_src: yes
  become: true
  become_user: "{{postgres_user}}"
  tags:
    - install_postgres

- name: Copy custom pg_hba.conf
  template:
    src: pg_hba.conf.j2
    dest: "{{postgres_home}}/9.6/data/pg_hba.conf"
    owner: "{{postgres_user}}"
    group: "{{postgres_group}}"
  become: true
  become_method: sudo
  tags:
    - install_postgres

- name: Enable PostgreSQL service
  systemd:
    name: postgresql-9.6
    daemon_reload: yes
    enabled: yes
  become: true
  become_method: sudo
  tags:
    - install_postgres

- name: Start PostgreSQL service
  systemd:
    name: postgresql-9.6
    state: started
  become: true
  become_method: sudo
  tags:
    - install_postgres

- name: Copy postgres password script
  template:
    src: set_postgres_password.sql.j2
    dest: "{{postgres_home}}/set_postgres_password.sql"
    owner: "{{postgres_user}}"
    group: "{{postgres_group}}"
  become: true
  become_method: sudo
  tags:
    - install_postgres

- name: Set postgres password
  shell: |
    "{{postgres_bin_home}}/psql -f {{postgres_home}}/set_postgres_password.sql"
  args:
    executable: /bin/bash
  become: true
  become_user: "{{postgres_user}}"
  tags:
    - install_postgres

- name: Stop PostgreSQL service
  systemd:
    name: postgresql-9.6
    state: stopped
  become: true
  become_method: sudo
  tags:
    - install_postgres

- name: Start PostgreSQL service
  systemd:
    name: postgresql-9.6
    state: started
  become: true
  become_method: sudo
  tags:
    - install_postgres

- name: Make directory for PostgreSQL JDBC Driver
  file:
    path: "{{postgres_home}}/jdbc"
    state: directory
    recurse: yes
  become: true
  become_method: sudo
  tags:
    - install_postgres

- name: Download PostgreSQL JDBC Driver jar
  aws_s3:
    aws_access_key: "{{aws_access_key}}"
    aws_secret_key: "{{aws_secret_key}}"
    bucket: rdurvasula-3rdparty
    object: "/postgresql/{{postgres_jdbc_jar}}"
    dest: "{{postgres_home}}/jdbc/{{postgres_jdbc_jar}}"
    mode: get
    region: "{{region}}"
    metadata: "Content-Type=application/octet-stream"
  become: true
  become_method: sudo
  tags:
    - install_postgres

- name: Set ownership to postgres
  file:
    path: "{{postgres_home}}"
    owner: "{{postgres_user}}"
    group: "{{postgres_group}}"
    recurse: yes
  become: true
  become_method: sudo
  tags:
    - install_postgres

- name: Delete working files
  file:
    path: "{{item}}"
    state: absent
  become: true
  become_method: sudo
  with_items:
    - "{{postgres_home}}/set_postgres_password.sql"
    - /root/postgresql96-libs-9.6.10-1PGDG.rhel7.x86_64.rpm
    - /root/postgresql96-9.6.10-1PGDG.rhel7.x86_64.rpm
    - /root/postgresql96-server-9.6.10-1PGDG.rhel7.x86_64.rpm
    - /root/postgresql96-contrib-9.6.10-1PGDG.rhel7.x86_64.rpm
  tags:
    - install_postgres

