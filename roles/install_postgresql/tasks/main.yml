---
#
# Play to install application packages
#
#
#

- name: Download PostgreSQL rpms from S3
  aws_s3:
    aws_access_key: "{{aws_access_key}}"
    aws_secret_key: "{{aws_secret_key}}"
    bucket: rdurvasula-3rdparty
    object: "/postgresql/{{item}}"
    dest: "/root/{{item}}"
    mode: get
    region: "{{region}}"
    metadata: "Content-Type=application/octet-stream"
  become: true
  become_method: sudo
  with_items:
    - postgresql96-contrib-9.6.10-1PGDG.rhel7.x86_64.rpm
    - postgresql96-libs-9.6.10-1PGDG.rhel7.x86_64.rpm
    - postgresql96-9.6.10-1PGDG.rhel7.x86_64.rpm
    - postgresql96-server-9.6.10-1PGDG.rhel7.x86_64.rpm
  tags:
    - install_postgres

- name: Install PostgreSQL server packages
  yum:
    name: "/root/{{item}}"
    state: present
  become: true
  become_method: sudo
  with_items:
    - postgresql96-libs-9.6.10-1PGDG.rhel7.x86_64.rpm
    - postgresql96-9.6.10-1PGDG.rhel7.x86_64.rpm
    - postgresql96-server-9.6.10-1PGDG.rhel7.x86_64.rpm
    - postgresql96-contrib-9.6.10-1PGDG.rhel7.x86_64.rpm
  tags:
    - install_postgres

- name: Initialize PostgreSQL Database
  shell: |
    /usr/pgsql-9.6/bin/postgresql96-setup initdb
  args:
    executable: /bin/bash
  become: true
  become_user: "{{postgres_user}}"
  tags:
    - install_postgres

- name: Enable PostgreSQL service
  systemd:
    name: postgresql-9.6
    daemon_reload: yes
    enabled: yes
  become: true
  become_method: sudo
  tags:
    - install_postgres

- name: Start PostgreSQL service
  systemd:
    name: postgresql-9.6
    state: started
  become: true
  become_method: sudo
  tags:
    - install_postgres

- name: Copy postgres password script
  template:
    src: set_postgres_password.sql.j2
    dest: /var/lib/pgsql/set_postgres_password.sql
    owner: "{{postgres_user}}"
    group: "{{postgres_group}}"
  become: true
  become_method: sudo
  tags:
    - install_postgres

- name: Set postgres password
  shell: |
    /usr/pgsql-9.6/bin/psql -f /var/lib/pgsql/set_postgres_password.sql
  args:
    executable: /bin/bash
  become: true
  become_user: "{{postgres_user}}"
  tags:
    - install_postgres

- name: Stop PostgreSQL service
  systemd:
    name: postgresql-9.6
    state: stopped
  become: true
  become_method: sudo
  tags:
    - install_postgres

- name: Start PostgreSQL service
  systemd:
    name: postgresql-9.6
    state: started
  become: true
  become_method: sudo
  tags:
    - install_postgres

